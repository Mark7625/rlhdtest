name: Check RuneLite Changes

on:
  schedule:
    # Check every hour on Monday-Wednesday from 7am to 5pm UTC
    - cron: '0 7-17 * * 1-3'
  workflow_dispatch: # Allow manual triggering

jobs:
  check-changes:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install requests
      
      - name: Check for RuneLite gameval changes
        id: check-runelite
        run: |
          python << 'EOF'
          import requests
          import json
          import os
          
          # Gameval file paths in RuneLite repo
          gameval_files = [
              "runelite-api/src/main/java/net/runelite/api/gameval/NpcID.java",
              "runelite-api/src/main/java/net/runelite/api/gameval/ObjectID.java",
              "runelite-api/src/main/java/net/runelite/api/gameval/ObjectID1.java",
              "runelite-api/src/main/java/net/runelite/api/gameval/AnimationID.java",
              "runelite-api/src/main/java/net/runelite/api/gameval/SpotanimID.java"
          ]
          
          # Get the latest commit from RuneLite master branch
          api_url = "https://api.github.com/repos/runelite/runelite/commits/master"
          response = requests.get(api_url)
          response.raise_for_status()
          latest_commit = response.json()
          latest_sha = latest_commit["sha"]
          latest_date = latest_commit["commit"]["committer"]["date"]
          
          # Get the last checked commit SHA from a file (or use default)
          last_sha_file = ".github/last-runelite-sha.txt"
          last_sha = None
          
          if os.path.exists(last_sha_file):
              with open(last_sha_file, 'r') as f:
                  last_sha = f.read().strip()
          
          # If we have a last SHA, check if files changed
          if last_sha and last_sha == latest_sha:
              print("No new commits")
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write("has_changes=false\n")
              exit(0)
          
          # Check if any gameval files were modified in recent commits
          # Get commits since last check (or last 10 commits if first run)
          if last_sha:
              compare_url = f"https://api.github.com/repos/runelite/runelite/compare/{last_sha}...{latest_sha}"
          else:
              # First run - check last 10 commits
              commits_url = "https://api.github.com/repos/runelite/runelite/commits?per_page=10"
              response = requests.get(commits_url)
              response.raise_for_status()
              commits = response.json()
              if not commits:
                  print("No commits found")
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write("has_changes=false\n")
                  exit(0)
              
              # Check files in recent commits
              files_changed = False
              for commit in commits:
                  commit_url = f"https://api.github.com/repos/runelite/runelite/commits/{commit['sha']}"
                  commit_response = requests.get(commit_url)
                  commit_response.raise_for_status()
                  commit_data = commit_response.json()
                  
                  for file in commit_data.get("files", []):
                      if file["filename"] in gameval_files:
                          files_changed = True
                          break
                  
                  if files_changed:
                      break
              
              if files_changed:
                  print("Gameval files changed in recent commits")
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write("has_changes=true\n")
              else:
                  print("No gameval file changes detected")
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write("has_changes=false\n")
              
              # Save current SHA
              with open(last_sha_file, 'w') as f:
                  f.write(latest_sha)
              exit(0)
          
          # Compare commits
          response = requests.get(compare_url)
          response.raise_for_status()
          compare_data = response.json()
          
          # Check if any gameval files were changed
          files_changed = False
          for file in compare_data.get("files", []):
              if file["filename"] in gameval_files:
                  files_changed = True
                  break
          
          if files_changed:
              print("Gameval files changed")
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write("has_changes=true\n")
          else:
              print("No gameval file changes detected")
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write("has_changes=false\n")
          
          # Save current SHA
          with open(last_sha_file, 'w') as f:
              f.write(latest_sha)
          EOF
      
      - name: Trigger update workflow
        if: steps.check-runelite.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'update-gamevals.yml',
              ref: 'master'
            });
      
      - name: Commit last checked SHA
        if: steps.check-runelite.outputs.has_changes == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/last-runelite-sha.txt
          git commit -m "Update last checked RuneLite SHA" || exit 0
          git push || exit 0

